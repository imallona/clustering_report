---
title: "Omnibenchmark backend comparison"
date: "`r format(Sys.time(), '%d %B, %Y %H:%M:%S')`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true
    number_sections: true
    df_print: kable
    theme: lumen
params:
    performance_bn: "performance-results.rds"
    metrics_bn: "metrics-results.rds"  # the metrics basenames as generated by `04_metric_collector.Rmd`
    clustering_dir: "" 
editor_options: 
  chunk_output_type: console
---


```{r}
library(dplyr)
library(ggplot2)
```

`bn` stands for basename (e.g. the RDS basenames generated by `04_metric_collector.Rmd`) and `clustering_dir` stands for the parent directory with all `out_conda`, `out_singularity` etc dirs. 

This report aims to generalize https://github.com/imallona/clustering_report/blob/6b4765d081f8882c7f7f40bf85fddefc02c1c7f2/quick-dirty-analysis.R

```
render("this.Rmd", params = list(performance_bn = "performance-results.rds",
                                metrics_bn = "metrics-results.rds",
                                clustering_dir =  "the path to the clustering_example"))
```

```{r}
## this will get as many performance/metrics files as runs there were
params <- list(performance_bn = "performance-results.rds",
               metrics_bn = "metrics-results.rds",
               clustering_dir =  "/home/imallona/src/clustering_example")


runs <- list.files(pattern = params$metrics_bn, path = params$clustering_dir, recursive = TRUE)

## for (run in runs) {
##     assign(dirname(run), value = readRDS(file.path(params$clustering_dir, run)))
## }

## but now we hardcode it instead
app <- readRDS(file.path(params$clustering_dir, grep('singularity', runs, value = TRUE)))
con <- readRDS(file.path(params$clustering_dir, grep('conda', runs, value = TRUE)))

## not run yet, just duplicating
## env <- readRDS(file.path(params$clustering_dir, grep('env', runs, value = TRUE)))
fakeenv <- con

```


```{r, fig.width = 10, fig.height = 10}
df <- app %>% select(data, method, metric, k) %>% 
  full_join(con %>% select(data, method, metric, k),
            by = c("data", "method", "metric"), 
            suffix = c(".apptainer",".conda")) %>%
  full_join(fakeenv %>% select(data, method, metric, k),
            by = c("data", "method", "metric"))
            
colnames(df)[ncol(df)] <- "k.fakeenvmodules"

ggplot(df, aes(x=k.apptainer,
               y=k.conda,
               colour = data)) +
  geom_point(size = 3) +
  geom_abline() +
  theme(legend.position = "none") +
  facet_wrap(~metric, scales = "free")

ggplot(df, aes(x=k.fakeenvmodules,
               y=k.conda,
               colour = data)) +
  geom_point(size = 3) +
  geom_abline() +
  theme(legend.position = "none") +
  facet_wrap(~metric, scales = "free")


ggplot(df, aes(x=k.apptainer,
               y=k.conda,
               colour = data,
               fill = method)) +
  geom_point(size = 3) +
  geom_abline() +
  theme(legend.position = "none") +
  facet_wrap(~method, scales = "free")

(df %>% filter(abs(k.apptainer-k.conda) > .001) %>% 
  pull(method) %>% table() -> big_diffs)


ggplot(df %>% filter(method %in% names(big_diffs)), aes(x=k.apptainer,
               y=k.conda,
               colour = data,
               fill = method)) +
  geom_point(size = 3) +
  geom_abline() +
  theme(legend.position = "none") +
  facet_grid(method ~ metric, scales = "free_y")

ggplot(df, aes(y=k.apptainer-k.conda,
               x=method,
               colour = method)) +
  geom_point(size = 3) +
  geom_abline() +
  theme(legend.position = "bottom") +
  facet_wrap(~metric, scales = "free")


ggplot(df, aes(y=k.apptainer-k.conda,
               x=data,
               colour = data)) +
  geom_point(size = 3) +
  geom_abline() +
  theme(legend.position = "bottom") +
  facet_wrap(~metric, scales = "free")
```
